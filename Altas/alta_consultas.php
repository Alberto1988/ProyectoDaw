<?php require('../Aspecto/libreria.inc');cabecera_alta();function LimpiaResultados($objeto){	foreach ($objeto as $atributo => $valor)		if(is_string($objeto->$atributo) === true)			$objeto->$atributo = stripslashes($objeto->$atributo);}class ExcepcionEnTransaccion extends Exception{	public function __construct(){}}?><!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Frameset//EN"><html><head>	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">	<title>Alta Consultas</title></head><body><?phpif (isset($_GET['alta'])===false) {?><form action="<?php echo $_SERVER['PHP_SELF'] ?>" method="get">	<TABLE>		<TR>			<TD>Id Consulta:</TD>			<TD><INPUT TYPE="text" NAME="id_consulta" SIZE="20" MAXLENGTH="30"></TD>		</TR>		<TR>			<TD>Fecha:</TD>			<TD><INPUT TYPE="text" NAME="fecha1" SIZE="4" MAXLENGTH="4">-<INPUT TYPE="text" NAME="fecha2" SIZE="2" MAXLENGTH="2">-<INPUT TYPE="text" NAME="fecha3" SIZE="2" MAXLENGTH="2"></TD>		</TR>		<TR>			<TD>Id Paciente:</TD>			<TD><INPUT TYPE="text" NAME="id_paciente" SIZE="20" MAXLENGTH="30"></TD>		</TR>		<TR>			<TD>Id Medico:</TD>			<TD><INPUT TYPE="text" NAME="id_medico" SIZE="20" MAXLENGTH="30"></TD>		</TR>		<TR>			<TD>Consultorio:</TD>			<TD><INPUT TYPE="text" NAME="consultorio" SIZE="20" MAXLENGTH="30"></TD>		</TR>		<TR>			<TD>Diagn&oacute;stico:</TD>			<TD><TEXTAREA NAME="diagnostico" SIZE="20" MAXLENGTH="30"></TEXTAREA></TD>		</TR>		<TR>			<TD><INPUT TYPE="submit" NAME="alta" VALUE="Alta" CLASS="guay"></TD>		</TR>	</TABLE></FORM><?php}else { $id_consulta=$_GET['id_consulta']; $fecha1=$_GET['fecha1'];$fecha2=$_GET['fecha2'];$fecha3=$_GET['fecha3'];$fecha_consulta=$fecha1.'-'.$fecha2.'-'.$fecha3;date_default_timezone_set('Europe/Madrid');$idpaciente=$_GET['id_paciente'];$idmedico=$_GET['id_medico'];$consultorio=$_GET['consultorio'];$diagnostico=$_GET['diagnostico'];try{	@ $db = new mysqli('localhost', 'root', 'root');	if (mysqli_connect_errno() != 0)		throw new Exception('Error conectando:'.mysqli_connect_error(), mysqli_connect_errno());		$db->select_db('clinica');	if ($db->errno != 0)		throw new Exception('Error seleccionando bd:'.$db->error, $db->errno);		$consulta = "insert into consultas_medicas(id_consulta,fecha_consulta,id_paciente,id_medico,consultorio,diagnostico) values ($id_consulta,'$fecha_consulta','$idpaciente','$idmedico','$consultorio','$diagnostico')";	if ($db->query($consulta) === false)		throw new ExcepcionEnTransaccion();	$db->commit();		$consulta = "select id_consulta,fecha_consulta,id_paciente,id_medico,consultorio,diagnostico from consultas_medicas";	$resultado = $db->query($consulta);	if ($db->errno != 0)		throw new Exception('Error realizando consulta:'.$db->error, $db->errno);	assert($resultado !== false);	if ($resultado->num_rows > 0){			echo '<table border="1">';			echo'<tr>';				echo'<th>IDCONSULTA</th>';				echo'<th>FECHA</th>';				echo'<th>IDPACIENTE</th>';				echo'<th>IDMEDICO</th>';				echo'<th>CONSULTORIO</th>';				echo'<th>DIAGNOSTICO</th>';			echo'</tr>';			while ($obj = $resultado->fetch_object()){				LimpiaResultados($obj);				echo'<tr>';					echo'<td align="center">'.$obj->id_consulta.'</td>';					echo'<td align="center">'.$obj->fecha_consulta.'</td>';					echo'<td align="center">'.$obj->id_paciente.'</td>';					echo'<td align="center">'.$obj->id_medico.'</td>';					echo'<td align="center">'.$obj->consultorio.'</td>';					echo'<td align="center">'.$obj->diagnostico.'</td>';				echo'</tr>';			}			echo'</table>';		}	else echo '<p>No hay datos que mostrar</p>';	?>	<p id="n_alta">[<a href="<?php echo $_SERVER['PHP_SELF'] ?>">Nueva alta</a>]</p>	<?php	$resultado->free(); 	$db->close(); }catch (ExcepcionEnTransaccion $e){	echo 'No se ha podido realizar al alta';	$db->rollback();	$db->close();}catch (Exception $e){	echo $e->getMessage();	if (mysqli_connect_errno() == 0)		$db->close();	exit();}}?></body></html>